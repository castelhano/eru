{% extends "layout/app.html" %}
{% load static i18n ui_components %}
{% block title %}{% translate 'Frequência'|escapejs %}{% endblock %}
{% block canvas_menu %}{% include '_component/menu/pessoal.html' %}{% endblock %}

<style>
  {% block style %}
  .sticky_card {
    position: sticky;
    top: 50px;
    z-index: 1020;
  }
  
  .is-stuck {
    top: 48px !important;
    margin-top: 0 !important;
    width: 100vw !important;
    max-width: none !important;
    margin-left: calc(-50vw + 50%) !important;
    margin-right: calc(-50vw + 50%) !important;
    border-radius: 0 !important;
    border-top: none !important;
    border-left: none !important;
    border-right: none !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
  }
  
  body {
    overflow-x: hidden;
  }

@media (max-width: 991.98px) {
  /* borda lateral colorida indica a origem do registro, so aplicado no mobile */
  [data-role="horarioRow"] {
    border-left: 2px solid transparent;
    padding-left: 4px;
    border-radius: 2px;
  }
  [data-role="horarioRow"][data-origem="manual"]  { border-color: var(--bs-warning); }
  [data-role="horarioRow"][data-origem="ponto"]   { border-color: var(--bs-info);    }
  [data-role="horarioRow"][data-origem="sistema"] { border-color: var(--bs-secondary); }
  [data-role="horarioRow"][data-origem="escala"]  { border-color: var(--bs-secondary-color); }
  /* nova linha (sem id) — sem borda, discreta */
  [data-role="horarioRow"][data-origem="novo"]    { border-color: var(--bs-secondary-color); }
}


  
  {% endblock %}
</style>


{% block content_fluid %}

<!-- template oculto: base para clonagem de linhas de horario via JS -->
<template id="horario-row-tpl">
  <div class="row mb-2 g-2" data-role="horarioRow" data-dia-inteiro="false" data-origem="novo">
    <input type="hidden" data-field="id" value="">
    <div class="col-auto d-none d-lg-flex align-items-center">
      <i class="bi bi-plus-lg text-body-secondary" data-role="origemIcon"></i>
    </div>
    <div class="col-6 col-md-2" data-field-wrapper="entrada">
      <label class="form-label small d-md-none">{% translate 'Entrada'|escapejs %}</label>
      <input type="time" class="form-control form-control-sm" data-field="entrada">
    </div>
    <div class="col-6 col-md-2" data-field-wrapper="saida">
      <label class="form-label small d-md-none">{% translate 'Saída'|escapejs %}</label>
      <input type="time" class="form-control form-control-sm" data-field="saida">
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label small d-md-none">{% translate 'Evento'|escapejs %}</label>
      <select class="form-select form-select-sm" data-field="evento">
        {% for ev in eventos_choices %}
        <option value="{{ ev.id }}"
        data-dia-inteiro="{{ ev.dia_inteiro|yesno:'true,false' }}"
        data-categoria="{{ ev.categoria }}"
        data-cor="{{ ev.cor|default:'' }}">
        {{ ev.nome }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md">
    <label class="form-label small d-md-none">{% translate 'Observação'|escapejs %}</label>
    <input type="text" class="form-control form-control-sm" data-field="observacao" placeholder="{% translate 'Observação'|escapejs %}...">
  </div>
  <div class="col-md-auto text-end">
    <button type="button" class="btn btn-sm btn-danger-matte" data-role="removeHorario">
      <i class="bi bi-trash3-fill"></i>
    </button>
  </div>
</div>
</template>

<div class="card mt-2"><!-- card principal -->
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-bs-target="#base" href="#"><i class="bi bi-list"></i></a></li>
    </ul>
  </div>
  
  <div class="card-body tab-content">
    <h5 class="card-title mb-3">{% translate 'Pessoal'|escapejs %}: <b class="text-purple">{% translate 'Frequência'|escapejs %}</b></h5>
    
    <form method="get" id="form-filtro" class="row g-3" autocomplete="off">
      <div class="tab-pane fade show active" id="base" role="tabpanel">
        
        <!-- filtro -->
        <div class="row g-1">
          <div class="form-floating mb-lg-1 col-lg-3">
            <input type="text" id="id_matricula" name="matricula" value="{{ filtro_form.matricula }}" class="form-control" placeholder=" " required autofocus>
            <label for="id_matricula">{% translate 'Matrícula'|escapejs %}</label>
          </div>
          <div class="col-lg-3 mb-1">
            <div class="input-group">
              <div class="form-floating">
                <input type="month" id="id_competencia" name="competencia" value="{{ filtro_form.competencia }}" class="form-control" required>
                <label for="id_competencia">{% translate 'Competência'|escapejs %}</label>
              </div>
              <button class="btn btn-primary-matte px-3" type="submit"><i class="bi bi-search"></i></button>
            </div>
          </div>
        </div><!-- /filtro -->
        
        {% if contrato %}
        
        <!-- header resumo do funcionario -->
        <div class="card my-1 sticky_card hl-primary rounded">
          <div class="card-body py-2 text-bg-primary-matte">
            <div class="row">
              <div class="col d-flex align-items-center order-1 text-nowrap overflow-hidden">
                <span class="text-truncate me-1">{{ funcionario.nome }}</span>
                <span class="d-none d-lg-inline">({{ funcionario.matricula }}) [ <b>{{ contrato.cargo.nome }}</b> ]</span>
              </div>
              <div class="col-lg d-flex align-items-center order-3 order-lg-2">
                <b class="text-body-secondary">{{ competencia|date:"F/Y" }}</b>
              </div>
              <div class="col-auto order-2 order-lg-3">
                <div class="input-group text-end">
                  {% btn_tag 'submit' type="button" class="btn btn-sm btn-success-matte" data_role="saveAll" %}
                  <button id="extra" class="btn btn-sm btn-success-matte active dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"></button>
                  <ul class="dropdown-menu dropdown-menu-end fs-7">
                    <li><button type="button" class="dropdown-item dropdown-item-purple" data-role="carregarEscalaTodos"><i class="bi bi-arrow-bar-down me-2"></i>{% translate 'Carregar escala'|escapejs %}</button></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#"><i class="bi bi-percent me-2"></i> Extrato</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <!-- filtros -->
            <div class="row gx-2 small text-body-tertiary mt-2">
              <div class="col col-lg-auto pt-1 order-1">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="id_filter_empty">
                  <label class="form-check-label" for="id_filter_empty">{% translate 'Pendentes'|escapejs %}</label>
                </div>                
              </div>
              <div class="col-lg-auto order-3 order-lg-2 mb-1 mb-lg-0">
                <select id="id_filter_categoria" class="form-select form-select-sm">
                  <option value="">------</option>
                  {% for valor, nome in categorias %}
                  <option value="{{valor}}">{{nome}}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-lg-auto order-4 order-lg-3">
                <div class="input-group">
                  <input type="date" class="form-control form-control-sm" id="id_filter_inicio">
                  <input type="date" class="form-control form-control-sm" id="id_filter_fim">
                </div>
              </div>
              <div class="col-auto order-2 order-lg-4 mb-1 mb-lg-0">
                <button type="button" id="btn_filter" data-role="run_filter" class="btn btn-sm btn-info-matte"><i class="bi bi-funnel-fill"></i></button>
                <button type="button" id="btn_clear_filter" data-role="clear_filter" class="btn btn-sm btn-primary-matte" style="display: none;"><i class="bi bi-x-lg"></i></button>
              </div>
            </div><!-- fecha row de filtros -->
          </div><!-- fecha card body -->
        </div><!-- /header resumo -->
        
        <!-- calendario: data-evento-folga usado pelo JS para selecionar evento de folga -->
        <div id="calendario-frequencia" data-role="calendario" data-evento-folga="{{ evento_folga_id|default:'' }}">
          
          {% for dia, info in dias_mes.items %}
          {% if not info.bloqueado %}
          
          <div class="card mt-2"><!-- card dia -->
            <div class="card-header">
              <div class="row g-1">
                <div class="col d-flex align-items-center text-body-secondary text-truncate">{{ dia|date:"d/m/y (l)" }}</div>
                <div class="col-auto d-flex gap-1">
                  {% if info.escala and not info.escala_folga or info.escala_folga and evento_folga_id %}
                  <!-- botao visivel se ha escala de jornada OU folga com evento configurado -->
                  <button type="button" class="btn btn-sm btn-secondary-matte"
                  data-role="carregarEscala"
                  data-dia="{{ dia|date:'Y-m-d' }}"
                  data-escala='{{ info.escala_json }}'
                  data-folga="{{ info.escala_folga|yesno:'true,false' }}">
                  <i class="bi bi-calendar2-week"></i> Escala
                </button>
                {% endif %}
                <button type="button" class="btn btn-sm btn-success-matte" data-role="addHorario" data-dia="{{ dia|date:'Y-m-d' }}">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </div>
            </div>
          </div><!-- /card-header dia -->
          
          <div class="card-body">
            
            {% if info.escala %}
            <p class="text-body-secondary small mb-2">
              <i class="bi bi-calendar2-week"></i> Escala: <b>{{ info.escala }}</b>
            </p>
            {% endif %}
            
            <div data-role="horariosContainer" data-dia="{{ dia|date:'Y-m-d' }}">
              {% for h in info.horarios %}
              <div class="row mb-2 g-2" 
              data-role="horarioRow" 
              data-dia-inteiro="{{ h.dia_inteiro|default:'false' }}" 
              data-origem="{% if h.id %}{{ h.origem }}{% else %}escala{% endif %}"
              >
                <input type="hidden" data-field="id" value="{{ h.id|default:'' }}">
                
                <!-- icone indica origem do registro -->
                <div class="col-auto d-none d-lg-flex align-items-center">
                  {% if h.id %}
                    {% if h.origem == 'manual' %}
                    <i class="bi bi-pencil-fill text-warning-matte" data-role="origemIcon" title="{% translate 'Editado manualmente'|escapejs %}"></i>
                    {% elif h.origem == 'ponto' %}
                    <i class="bi bi-clock-fill text-info" data-role="origemIcon" title="{% translate 'Importação'|escapejs %}"></i>
                    {% else %}
                    <i class="bi bi-gear-fill text-secondary" data-role="origemIcon" title="Gerado pelo sistema"></i>
                    {% endif %}
                  {% else %}
                    <i class="bi bi-calendar2-week text-body-secondary" data-role="origemIcon" title="{% translate 'Novo'|escapejs %}"></i>
                  {% endif %}
                </div>
                
                <div class="col-6 col-md-2" data-field-wrapper="entrada">
                  <label class="form-label small d-md-none">{% translate 'Entrada'|escapejs %}</label>
                  <input type="time" class="form-control form-control-sm" data-field="entrada" value="{{ h.entrada }}">
                </div>
                <div class="col-6 col-md-2" data-field-wrapper="saida">
                  <label class="form-label small d-md-none">{% translate 'Saída'|escapejs %}</label>
                  <input type="time" class="form-control form-control-sm" data-field="saida" value="{{ h.saida }}">
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label small d-md-none">{% translate 'Evento'|escapejs %}</label>
                  <select class="form-select form-select-sm" data-field="evento">
                    {% for ev in eventos_choices %}
                    <option value="{{ ev.id }}"
                    data-dia-inteiro="{{ ev.dia_inteiro|yesno:'true,false' }}"
                    data-categoria="{{ ev.categoria }}"
                    data-cor="{{ ev.cor|default:'' }}"
                    {% if ev.id == h.evento_id %}selected{% endif %}>
                    {{ ev.nome }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md">
                <label class="form-label small d-md-none">{% translate 'Observação'|escapejs %}</label>
                <input type="text" class="form-control form-control-sm" data-field="observacao" placeholder="{% translate 'Observação'|escapejs %}..." value="{{ h.observacao|default:'' }}">
              </div>
              <div class="col-md-auto text-end">
                <button type="button" class="btn btn-sm btn-danger-matte" data-role="removeHorario">
                  <i class="bi bi-trash3-fill"></i>
                </button>
              </div>
            </div><!-- /horarioRow -->
            {% endfor %}<!-- /for info.horarios -->
          </div><!-- /horariosContainer -->
          <!-- adiciona resumo de horas ao final de cada dia -->
          <div class="mt-2" data-role="resumoDia">
            <small class="text-body-secondary">
              {% translate 'Horas'|escapejs %}: <strong data-field="horasTotais">--</strong> |
              {% translate 'Intrajornada'|escapejs %}: <strong data-field="intrajornada">--</strong> |
              {% translate 'Interjornada'|escapejs %}: <strong data-field="interjornada">--</strong>
            </small>
          </div>          
        </div><!-- /card-body dia -->
      </div><!-- /card dia -->
      
      {% endif %}<!-- /if not bloqueado -->
      {% endfor %}<!-- /for dias_mes -->
      
    </div><!-- /calendario -->
    
    {% endif %}<!-- /if contrato -->
    
  </div><!-- /tab-pane -->
</form>

</div><!-- /card-body tab-content -->
</div><!-- /card principal -->
{% endblock %}

<script>
  {% block add_script %}
  
  {% if contrato %}
  const sticky_card = document.querySelector('.sticky_card');
  window.addEventListener('scroll', () => {
    const rect = sticky_card.getBoundingClientRect();
    if (rect.top <= 50) sticky_card.classList.add('is-stuck');
    else sticky_card.classList.remove('is-stuck');
  });
  {% endif %}
  
  (function () {
    'use strict';
    
    const $$ = {
      btnSave: document.querySelector('[data-role="saveAll"]'),
      matricula: document.getElementById('id_matricula'),
      competencia: document.getElementById('id_competencia'),
      rowTpl: document.getElementById('horario-row-tpl'),
      eventoFolgaId: document.querySelector('[data-role="calendario"]')?.dataset.eventoFolga || null,
    };
    
    let isSaving = false;
    const deletarIds = new Set();
    const deletarRelatedIds = new Set();
    
    function novaRow() {
      return $$.rowTpl.content.firstElementChild.cloneNode(true);
    }
    
    function aplicarCorEvento(select) {
      const opt = select.options[select.selectedIndex];
      const cor = opt?.dataset.cor || '';
      select.style.backgroundColor = cor;
      if (cor) {
        const r = parseInt(cor.slice(1,3),16), g = parseInt(cor.slice(3,5),16), b = parseInt(cor.slice(5,7),16);
        select.style.color = (0.299*r + 0.587*g + 0.114*b)/255 > 0.5 ? '#000' : '#fff';
      } else {
        select.style.color = '';
      }
    }
    
    // converte "HH:MM" em minutos totais
    function timeToMinutes(t) {
      if (!t) return null;
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    }
    
    function minutesToTime(min) {
      return `${String(Math.floor(min/60)).padStart(2,'0')}:${String(min%60).padStart(2,'0')}`;
    }
    
    // detecta virada de dia (saida <= entrada) e atualiza icone da linha
    function atualizarVirada(row, editando=false) {
      const entrada = timeToMinutes(row.querySelector('[data-field="entrada"]').value);
      const saida   = timeToMinutes(row.querySelector('[data-field="saida"]').value);
      const isDiaInteiro = row.dataset.diaInteiro === 'true';
      const virada = !isDiaInteiro && entrada !== null && saida !== null && saida <= entrada;
      row.dataset.virada = virada;
      if (!editando) return;
      const icon = row.querySelector('[data-role="origemIcon"]');
      if (!icon) return;
       if (virada) {
        icon.dataset.classeOriginal ??= icon.className;  // salva só na primeira vez
        icon.dataset.tituloOriginal ??= icon.title;
        icon.className = 'bi bi-moon-fill text-orange';
        icon.title = '+1 dia (virada de dia)';
      } else if (icon.dataset.classeOriginal) {
        icon.className = icon.dataset.classeOriginal;
        icon.title     = icon.dataset.tituloOriginal;
        delete icon.dataset.classeOriginal;
        delete icon.dataset.tituloOriginal;
      }
    }
    
    
    // calcula e exibe resumo de horas do dia no bloco resumoDia
    function calcularResumoDia(container) {
      const resumo = container.closest('.card-body')?.querySelector('[data-role="resumoDia"]');
      if (!resumo) return;
      
      // oculta resumo se houver evento de dia inteiro ativo no container
      const temDiaInteiro = container.querySelector('[data-role="horarioRow"][data-dia-inteiro="true"]');
      if (temDiaInteiro) { resumo.style.display = 'none'; return; }
      resumo.style.display = '';
      
      const rows = [...container.querySelectorAll('[data-role="horarioRow"]')]
      .filter(r => !r.classList.contains('pe-none'));
      
      const slots = [];
      for (const row of rows) {
        let entrada = timeToMinutes(row.querySelector('[data-field="entrada"]').value);
        let saida   = timeToMinutes(row.querySelector('[data-field="saida"]').value);
        if (entrada === null || saida === null) continue;
        if (saida <= entrada) saida += 1440; // normaliza virada
        slots.push({ entrada, saida });
      }
      
      const temDados = slots.length > 0;
      let totalMin = 0, intraMin = 0;
      slots.forEach((s, i) => {
        totalMin += s.saida - s.entrada;
        if (i > 0) intraMin += s.entrada - slots[i-1].saida;
      });
      
      // interjornada: tempo livre entre fim deste dia e início do próximo (baseado em 24h de ciclo)
      const interjornada = temDados
      ? (slots[0].entrada + 1440) - slots[slots.length-1].saida
      : 0;
      
      resumo.querySelector('[data-field="horasTotais"]').textContent   = temDados ? minutesToTime(totalMin) : '--';
      resumo.querySelector('[data-field="interjornada"]').textContent  = temDados ? minutesToTime(interjornada) : '--'; // exibe antes de intra
      resumo.querySelector('[data-field="intrajornada"]').textContent  = temDados && slots.length > 1 ? minutesToTime(intraMin) : '--';
    }
    
    
    function toggleRowFields(row) {
      const select = row.querySelector('[data-field="evento"]');
      const isDiaInteiro = select.selectedOptions[0]?.dataset.diaInteiro === 'true';
      row.querySelectorAll('[data-field-wrapper]').forEach(w => w.style.display = isDiaInteiro ? 'none' : '');
      row.setAttribute('data-dia-inteiro', isDiaInteiro);
      aplicarCorEvento(select);
      atualizarVirada(row);
      const container = row.closest('[data-role="horariosContainer"]');
      if (!container) return;
      [...container.querySelectorAll('[data-role="horarioRow"]')]
      .filter(r => r !== row)
      .forEach(r => {
        ['opacity-50','pe-none','text-decoration-line-through'].forEach(cls => r.classList.toggle(cls, isDiaInteiro));
        const id = r.querySelector('[data-field="id"]').value;
        if(id) isDiaInteiro ? deletarRelatedIds.add(id) : deletarRelatedIds.delete(id);
      });
      calcularResumoDia(container); // atualiza resumo após qualquer mudança de evento
    }
    
    document.querySelectorAll('[data-role="horarioRow"]').forEach(toggleRowFields);
    document.querySelectorAll('[data-role="horariosContainer"]').forEach(container => {
      if (!container.querySelector('[data-role="horarioRow"]')) {
        const row = novaRow();
        container.appendChild(row);
        toggleRowFields(row);
      }
      calcularResumoDia(container); // inicializa resumo ao carregar página
    });
    
    document.addEventListener('click', e => {
      const target = e.target.closest('[data-role]');
      if (!target) return;
      const role = target.dataset.role;
      
      if (role === 'run_filter') { aplicarFiltros() }
      else if (role === 'clear_filter') { limparFiltros() }
      else if (role === 'addHorario') {
        const container = document.querySelector(`[data-role="horariosContainer"][data-dia="${target.dataset.dia}"]`);
        const row = novaRow();
        container.appendChild(row);
        toggleRowFields(row);
      }
      else if (role === 'carregarEscala') {
        const container = document.querySelector(`[data-role="horariosContainer"][data-dia="${target.dataset.dia}"]`);
        const ehFolga = target.dataset.folga === 'true';
        if (ehFolga) {
          const row = container.querySelector('[data-role="horarioRow"]');
          if (row) {
            const select = row.querySelector('[data-field="evento"]');
            const optFolga = [...select.options].find(o => o.value == $$.eventoFolgaId);
            if (optFolga) { optFolga.selected = true; toggleRowFields(row); }
          }
        } else {
          container.innerHTML = '';
          JSON.parse(target.dataset.escala).forEach(h => {
            const row = novaRow();
            row.querySelector('[data-field="entrada"]').value = h.entrada || '';
            row.querySelector('[data-field="saida"]').value   = h.saida || '';
            container.appendChild(row);
            toggleRowFields(row);
          });
        }
        target.classList.replace('btn-secondary-matte', 'btn-success-matte');
        target.disabled = true;
        calcularResumoDia(container);
      }
      else if (role === 'removeHorario') {
        const container = target.closest('[data-role="horariosContainer"]');
        const row = target.closest('[data-role="horarioRow"]');
        const id = row.querySelector('[data-field="id"]').value;
        if (container.querySelectorAll('[data-role="horarioRow"]').length > 1) {
          if (id) deletarIds.add(id);
          row.remove();
          calcularResumoDia(container); // atualiza resumo apos remocao
        } else {
          // ao tentar apagar ultima linha, apenas limpa dados
          if (id) deletarIds.add(id);
          row.dataset.deleted = 'true';
          row.querySelector('[data-field="id"]').value        = '';
          row.querySelector('[data-field="entrada"]').value   = '';
          row.querySelector('[data-field="saida"]').value     = '';
          row.querySelector('[data-field="observacao"]').value = '';
          row.querySelector('[data-field="evento"]').selectedIndex = 0;
          toggleRowFields(row);   // reseta cor, dia-inteiro, virada
          calcularResumoDia(container); // reseta resumo de horas
        }
      }
      else if (role === 'saveAll') {
        saveFrequencias();
      }
    });
    
    document.addEventListener('change', e => {
      // marca linha como data-dirty=true para informar que foi alterada, somente linhas 
      // alteradas são enviadas para o payload
      if (['entrada', 'saida', 'evento', 'observacao'].includes(e.target.dataset.field)) {
        e.target.closest('[data-role="horarioRow"]')?.setAttribute('data-dirty', 'true');
      }
      if (e.target.dataset.field === 'evento')
      toggleRowFields(e.target.closest('[data-role="horarioRow"]'));
      // atualiza virada e resumo ao mudar qualquer campo de hora
      if (e.target.dataset.field === 'entrada' || e.target.dataset.field === 'saida') {
        const row = e.target.closest('[data-role="horarioRow"]');
        atualizarVirada(row, true);
        calcularResumoDia(row.closest('[data-role="horariosContainer"]'));
      }
    });
    
    // carregar escala para todos os dias nao preenchidos
    document.querySelector('[data-role="carregarEscalaTodos"]')?.addEventListener('click', () => {
      document.querySelectorAll('[data-role="carregarEscala"]').forEach(btn => {
        if (btn.disabled) return; // já carregado
        
        const container = document.querySelector(
        `[data-role="horariosContainer"][data-dia="${btn.dataset.dia}"]`
        );
        if (!container) return;
        
        // pula se ha qualquer registro ja salvo (id preenchido)
        const temSalvo = [...container.querySelectorAll('[data-field="id"]')]
        .some(el => el.value.trim() !== '');
        if (temSalvo) return;
        
        // pula se há evento dia inteiro ativo
        const temDiaInteiro = container.querySelector(
        '[data-role="horarioRow"][data-dia-inteiro="true"]'
        );
        if (temDiaInteiro) return;
        
        btn.click();
      });
    });
    
    function saveFrequencias() {
      if (isSaving) return;
      const frequencias = [];
      const slotsPorDia = {};
      
      document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
      
      for (const row of document.querySelectorAll('[data-role="horarioRow"]')) {
        if (row.dataset.deleted === 'true') continue; // linha apagada, já em deletarIds
        const isDirty = row.dataset.dirty === 'true' || !row.querySelector('[data-field="id"]').value;
        if (!isDirty) continue; // ignora linhas nao alteradas
        if (row.classList.contains('pe-none')) continue;
        const container = row.closest('[data-role="horariosContainer"]');
        const dia = container.dataset.dia;
        const evSelect  = row.querySelector('[data-field="evento"]');
        const inputIn   = row.querySelector('[data-field="entrada"]');
        const inputOut  = row.querySelector('[data-field="saida"]');
        const isDiaInteiro = evSelect.options[evSelect.selectedIndex]?.dataset.diaInteiro === 'true';
        const hIn = inputIn.value, hOut = inputOut.value;
        
        if (!evSelect.value || (!isDiaInteiro && !hIn && !hOut)) continue;
        
        if (!isDiaInteiro && (!hIn || !hOut)) {
          inputIn.classList.add('is-invalid');
          inputOut.classList.add('is-invalid');
          return;
        }
        
        const valIn  = isDiaInteiro ? '00:00' : hIn;
        const valOut = isDiaInteiro ? '23:59' : hOut;
        // virada: saida no dia seguinte — sinaliza ao backend via flag
        const virada = row.dataset.virada === 'true';
        if (!virada && timeToMinutes(valOut) <= timeToMinutes(valIn)) {
          inputIn.classList.add('is-invalid');
          inputOut.classList.add('is-invalid');
          appNotify('warning', `Horário de fim não pode ser menor que início em ${dia}`);
          return;
        }
        
        if (!slotsPorDia[dia]) slotsPorDia[dia] = [];
        // para comparação de overlap, normaliza saida de virada com +1440min
        const minIn  = timeToMinutes(valIn);
        const minOut = timeToMinutes(valOut) + (virada ? 1440 : 0);
        const conflito = slotsPorDia[dia].find(s => minIn < s.out && minOut > s.in);
        if (conflito) {
          conflito.rowRef.querySelector('[data-field="saida"]').classList.add('is-invalid');
          inputIn.classList.add('is-invalid');
          appNotify('warning', 'Registro sobrepõe outras entradas existentes');
          return;
        }
        
        slotsPorDia[dia].push({ in: minIn, out: minOut, rowRef: row });
        frequencias.push({
          id: row.querySelector('[data-field="id"]').value || null,
          dia, entrada: valIn, saida: valOut,
          virada, // backend usa para incrementar data de saida
          evento_id: evSelect.value,
          observacao: row.querySelector('[data-field="observacao"]').value,
        });
      }
      
      if (!frequencias.length && !deletarIds.size && !deletarRelatedIds.size) { appNotify('warning', 'Nenhuma frequência preenchida para salvar'); return;}
      
      isSaving = true;
      const btn = $$.btnSave;
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Salvando...';
      
      fetch(window.location.pathname, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ 
          matricula: $$.matricula.value, 
          competencia: $$.competencia.value, 
          frequencias,
          deletar_ids: [...deletarIds],
          deletar_related_ids: [...deletarRelatedIds],
        }),
      })
      .then(r => r.ok ? r.json() : r.json().then(err => { throw err; }))
      .then(data => {
        if (data.status === 'success') window.location.reload();
        else throw new Error(data.message || 'Erro desconhecido');
      })
      .catch(error => {
        appAlert('danger', 'Erro: ' + (error.message || error), false);
        isSaving = false;
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      });
    }
    
    // funcao para filtro nas linhas (tudo no cliente)
    // apenas aplica d-none
    function filtrarDias(options = {}) {
      const {
        apenasVazios = false,
        categoria    = null,
        inicio   = null,
        fim      = null,
      } = options;
      
      document.querySelectorAll('[data-role="horariosContainer"]').forEach(container => {
        const card = container.closest('.card');
        const dia  = container.dataset.dia; // formato YYYY-MM-DD
        
        // intervalo de datas
        if (inicio && dia < inicio) { card.style.display = 'none'; return; }
        if (fim    && dia > fim)    { card.style.display = 'none'; return; }
        
        // filtro dias em branco: nenhum id salvo E nenhum valor preenchido
        if (apenasVazios) {
          const temSalvo   = [...container.querySelectorAll('[data-field="id"]')].some(el => el.value);
          const temPreench = [...container.querySelectorAll('[data-field="entrada"]')].some(el => el.value);
          if (temSalvo || temPreench) { card.style.display = 'none'; return; }
        }
        
        // filtro por categoria de evento
        if (categoria) {
          const rows = [...container.querySelectorAll('[data-role="horarioRow"]')];
          const bate = rows.some(row => {
            const sel = row.querySelector('[data-field="evento"]');
            return sel?.selectedOptions[0]?.dataset.categoria === categoria;
          });
          if (!bate) { card.style.display = 'none'; return; }
        }        
        card.style.display = '';
      });
    }
    
    function aplicarFiltros() {
      const apenasVazios = document.getElementById('id_filter_empty')?.checked   ?? false;
      const categoria    = document.getElementById('id_filter_categoria')?.value || null;
      const inicio       = document.getElementById('id_filter_inicio')?.value    || null;
      const fim          = document.getElementById('id_filter_fim')?.value       || null;
      
      filtrarDias({ apenasVazios, categoria, inicio, fim });
      
      // indica visualmente que há filtro ativo
      const temFiltro = apenasVazios || categoria || inicio || fim;
      document.getElementById('btn_clear_filter').style.display = temFiltro ? '' : 'none';
    }
    
    function limparFiltros() {
      const ids = ['id_filter_empty', 'id_filter_categoria', 'id_filter_inicio', 'id_filter_fim'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === 'checkbox') el.checked = false;
        else el.value = '';
      });
      filtrarDias({}); // chama funcao sem params para limpar filtros
      document.getElementById('btn_clear_filter').style.display = 'none';
    }
    
    
    
  })();
  
  {% endblock %}
</script>