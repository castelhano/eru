{% extends "layout/app.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
  <h4 class="mb-3">Edi√ß√£o de Frequ√™ncia Mensal</h4>
  
  <!-- Formul√°rio de Filtro -->
  <div class="card mb-3">
    <div class="card-body">
      <form method="get" id="form-filtro" class="row g-3">
        <div class="col-md-4">
          <label for="matricula" class="form-label">Matr√≠cula</label>
          <input type="text" 
                 class="form-control" 
                 id="matricula" 
                 name="matricula" 
                 value="{{ filtro_form.matricula }}"
                 placeholder="Ex: 12345"
                 required>
        </div>
        <div class="col-md-4">
          <label for="competencia" class="form-label">Compet√™ncia</label>
          <input type="month" 
                 class="form-control" 
                 id="competencia" 
                 name="competencia" 
                 value="{{ filtro_form.competencia }}"
                 required>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary">üîç Buscar</button>
        </div>
      </form>
    </div>
  </div>

  {% if contrato %}
  <!-- Dados do Funcion√°rio -->
  <div class="alert alert-info d-flex justify-content-between align-items-center">
    <div>
      <strong>{{ funcionario.nome }}</strong> ({{ funcionario.matricula }}) - 
      {{ contrato.cargo.nome }} | 
      <span class="text-muted">{{ competencia|date:"F/Y" }}</span>
    </div>
    <button id="btn-save" class="btn btn-success">üíæ Salvar Todas</button>
  </div>

  <!-- Calend√°rio de Frequ√™ncias -->
  <div id="calendario-frequencia">
    {% for dia, horarios in dias_mes.items %}
    <div class="card mb-2">
      <div class="card-header d-flex justify-content-between align-items-center py-2">
        <strong>{{ dia|date:"d/m/Y (l)" }}</strong>
        <button type="button" class="btn btn-sm btn-outline-primary btn-add-horario" 
                data-dia="{{ dia|date:'Y-m-d' }}">
          ‚ûï Adicionar Hor√°rio
        </button>
      </div>
      <div class="card-body p-2">
        <div class="horarios-container" data-dia="{{ dia|date:'Y-m-d' }}">
          {% if horarios %}
            {% for h in horarios %}
            <div class="row mb-2 horario-row g-2" data-dia-inteiro="{{ h.dia_inteiro|default:'false' }}">
              <input type="hidden" class="freq-id" value="{{ h.id|default:'' }}">
              
              <!-- Entrada (col-2 em desktop, col-6 em mobile) -->
              <div class="col-6 col-md-2 horario-field">
                <label class="form-label small d-md-none">Entrada</label>
                <input type="time" class="form-control form-control-sm entrada" 
                       value="{{ h.entrada }}" 
                       {% if not h.dia_inteiro %}required{% endif %}>
              </div>
              
              <!-- Sa√≠da (col-2 em desktop, col-6 em mobile) -->
              <div class="col-6 col-md-2 horario-field">
                <label class="form-label small d-md-none">Sa√≠da</label>
                <input type="time" class="form-control form-control-sm saida" 
                       value="{{ h.saida }}" 
                       {% if not h.dia_inteiro %}required{% endif %}>
              </div>
              
              <!-- Evento (col-12 md-3) -->
              <div class="col-12 col-md-3">
                <label class="form-label small d-md-none">Evento</label>
                <select class="form-select form-select-sm evento" data-dia-inteiro="{{ h.dia_inteiro|default:'false' }}">
                  {% for ev in eventos_choices %}
                  <option value="{{ ev.id }}" 
                          data-dia-inteiro="{{ ev.dia_inteiro|yesno:'true,false' }}"
                          {% if ev.id == h.evento_id %}selected{% endif %}>
                    {{ ev.nome }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Observa√ß√£o (col-10 md-4) -->
              <div class="col-10 col-md-4">
                <label class="form-label small d-md-none">Observa√ß√£o</label>
                <input type="text" 
                       class="form-control form-control-sm observacao" 
                       placeholder="Observa√ß√£o..."
                       value="{{ h.observacao|default:'' }}">
              </div>
              
              <!-- Bot√£o Remover (col-2 md-1) -->
              <div class="col-2 col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-danger btn-remove w-100">üóëÔ∏è</button>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <p class="text-muted mb-0">üìÖ Folga</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<script>
// ‚úÖ Template de eventos para JS
const eventoOptionsHTML = `
  {% for ev in eventos_choices %}
  <option value="{{ ev.id }}" data-dia-inteiro="{{ ev.dia_inteiro|yesno:'true,false' }}">
    {{ ev.nome }}
  </option>
  {% endfor %}
`;

// ‚úÖ Fun√ß√£o para mostrar/esconder campos de hor√°rio
function toggleHorarioFields(row, isDiaInteiro) {
  const horarioFields = row.querySelectorAll('.horario-field');
  const entradaInput = row.querySelector('.entrada');
  const saidaInput = row.querySelector('.saida');
  
  if (isDiaInteiro) {
    horarioFields.forEach(field => field.style.display = 'none');
    entradaInput.removeAttribute('required');
    saidaInput.removeAttribute('required');
    entradaInput.value = '';
    saidaInput.value = '';
  } else {
    horarioFields.forEach(field => field.style.display = '');
    entradaInput.setAttribute('required', 'required');
    saidaInput.setAttribute('required', 'required');
  }
}

// ‚úÖ Inicializa campos na carga da p√°gina
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.horario-row').forEach(row => {
    const eventoSelect = row.querySelector('.evento');
    if (eventoSelect) {
      const selectedOption = eventoSelect.selectedOptions[0];
      const isDiaInteiro = selectedOption.dataset.diaInteiro === 'true';
      toggleHorarioFields(row, isDiaInteiro);
    }
  });
});

// ‚úÖ Monitora mudan√ßa de evento
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('evento')) {
    const selectedOption = e.target.selectedOptions[0];
    const isDiaInteiro = selectedOption.dataset.diaInteiro === 'true';
    const row = e.target.closest('.horario-row');
    toggleHorarioFields(row, isDiaInteiro);
  }
});

// Adicionar novo hor√°rio
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('btn-add-horario')) {
    const dia = e.target.dataset.dia;
    const container = document.querySelector(`.horarios-container[data-dia="${dia}"]`);
    
    const folga = container.querySelector('.text-muted');
    if (folga) folga.remove();
    
    const template = `
      <div class="row mb-2 horario-row g-2" data-dia-inteiro="false">
        <input type="hidden" class="freq-id" value="">
        <div class="col-6 col-md-2 horario-field">
          <label class="form-label small d-md-none">Entrada</label>
          <input type="time" class="form-control form-control-sm entrada" required>
        </div>
        <div class="col-6 col-md-2 horario-field">
          <label class="form-label small d-md-none">Sa√≠da</label>
          <input type="time" class="form-control form-control-sm saida" required>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label small d-md-none">Evento</label>
          <select class="form-select form-select-sm evento">
            ${eventoOptionsHTML}
          </select>
        </div>
        <div class="col-10 col-md-4">
          <label class="form-label small d-md-none">Observa√ß√£o</label>
          <input type="text" class="form-control form-control-sm observacao" placeholder="Observa√ß√£o...">
        </div>
        <div class="col-2 col-md-1 d-flex align-items-end">
          <button type="button" class="btn btn-sm btn-danger btn-remove w-100">üóëÔ∏è</button>
        </div>
      </div>`;
    container.insertAdjacentHTML('beforeend', template);
  }
  
  if (e.target.classList.contains('btn-remove')) {
    const row = e.target.closest('.horario-row');
    const container = row.closest('.horarios-container');
    row.remove();
    
    if (container.querySelectorAll('.horario-row').length === 0) {
      container.innerHTML = '<p class="text-muted mb-0">üìÖ Folga</p>';
    }
  }
});

// Salvar
document.getElementById('btn-save')?.addEventListener('click', function() {
  const frequencias = [];
  const matricula = document.getElementById('matricula').value;
  const competencia = document.getElementById('competencia').value;
  
  document.querySelectorAll('.horarios-container').forEach(container => {
    const dia = container.dataset.dia;
    
    container.querySelectorAll('.horario-row').forEach(row => {
      const eventoSelect = row.querySelector('.evento');
      const selectedOption = eventoSelect.selectedOptions[0];
      const isDiaInteiro = selectedOption.dataset.diaInteiro === 'true';
      const entrada = row.querySelector('.entrada').value;
      const saida = row.querySelector('.saida').value;
      
      // ‚úÖ Eventos dia inteiro n√£o precisam de hor√°rios
      if (isDiaInteiro || (entrada && saida)) {
        frequencias.push({
          id: row.querySelector('.freq-id').value || null,
          dia: dia,
          entrada: entrada,
          saida: saida,
          evento_id: eventoSelect.value,
          observacao: row.querySelector('.observacao').value
        });
      }
    });
  });
  
  if (frequencias.length === 0) {
    alert('‚ö†Ô∏è Nenhuma frequ√™ncia para salvar.');
    return;
  }
  
  const btnSave = this;
  btnSave.disabled = true;
  btnSave.textContent = '‚è≥ Salvando...';
  
  fetch(window.location.pathname, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({
      matricula: matricula,
      competencia: competencia,
      frequencias: frequencias
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.status === 'success') {
      alert('‚úÖ Frequ√™ncias salvas com sucesso!');
      location.reload();
    } else {
      alert('‚ùå Erro: ' + data.message);
      btnSave.disabled = false;
      btnSave.textContent = 'üíæ Salvar Todas';
    }
  })
  .catch(error => {
    alert('‚ùå Erro: ' + error);
    btnSave.disabled = false;
    btnSave.textContent = 'üíæ Salvar Todas';
  });
});
</script>
{% endblock %}