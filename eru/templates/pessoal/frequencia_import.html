{% extends "layout/app.html" %}
{% load static i18n ui_components %}
{% block title %}Importação de Frequência{% endblock %}
{% block canvas_menu %}{% include '_component/menu/pessoal.html' %}{% endblock %}

<style>
{% block style %}
/* Design inspirado em fluxo de upload moderno */
.upload-zone {
  border: 3px dashed #cbd5e1;
  border-radius: 16px;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  padding: 3rem;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.upload-zone::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
  transition: left 0.5s;
}

.upload-zone:hover {
  border-color: #6366f1;
  background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
  transform: translateY(-2px);
}

.upload-zone:hover::before {
  left: 100%;
}

.upload-zone.dragover {
  border-color: #4f46e5;
  background: #dbeafe;
  transform: scale(1.02);
}

.upload-icon {
  font-size: 4rem;
  color: #6366f1;
  margin-bottom: 1rem;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

.file-info-card {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 1.5rem;
  margin-top: 1.5rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

.origem-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 600;
  transition: all 0.2s;
}

.origem-badge:hover {
  transform: scale(1.05);
}

.origem-AFD { background: #dbeafe; color: #1e40af; }
.origem-CSV { background: #dcfce7; color: #166534; }
.origem-APP { background: #fef3c7; color: #92400e; }
.origem-WEB { background: #f3e8ff; color: #6b21a8; }

.preview-table {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.preview-table thead {
  background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
  color: white;
}

.preview-table tbody tr {
  transition: background 0.2s;
}

.preview-table tbody tr:hover {
  background: #f8fafc;
}

.batida-badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  background: #f1f5f9;
  color: #475569;
  margin: 0.125rem;
}

.alert-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.25rem 0.5rem;
  border-radius: 8px;
  font-size: 0.75rem;
  background: #fef2f2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.stats-card {
  background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
  color: white;
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
  margin-bottom: 2rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 2rem;
}

.stat-item {
  text-align: center;
}

.stat-value {
  font-size: 3rem;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 0.5rem;
}

.stat-label {
  opacity: 0.9;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.step-indicator {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  margin-bottom: 3rem;
}

.step-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.step-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  background: #e2e8f0;
  color: #64748b;
  transition: all 0.3s;
}

.step-item.active .step-circle {
  background: #6366f1;
  color: white;
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
}

.step-item.completed .step-circle {
  background: #10b981;
  color: white;
}

.step-arrow {
  color: #cbd5e1;
  font-size: 1.5rem;
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-spinner {
  text-align: center;
  color: white;
}

.loading-spinner .spinner-border {
  width: 4rem;
  height: 4rem;
  border-width: 0.4rem;
}

.funcionario-card {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  transition: all 0.2s;
}

.funcionario-card:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  transform: translateX(4px);
}

.collapse-trigger {
  cursor: pointer;
  user-select: none;
}

.collapse-trigger i {
  transition: transform 0.3s;
}

.collapse-trigger[aria-expanded="true"] i {
  transform: rotate(90deg);
}

/* Animações de entrada */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in-up {
  animation: fadeInUp 0.5s ease-out;
}

.funcionario-card {
  animation: fadeInUp 0.3s ease-out backwards;
}

.funcionario-card:nth-child(1) { animation-delay: 0.05s; }
.funcionario-card:nth-child(2) { animation-delay: 0.1s; }
.funcionario-card:nth-child(3) { animation-delay: 0.15s; }
.funcionario-card:nth-child(4) { animation-delay: 0.2s; }
.funcionario-card:nth-child(5) { animation-delay: 0.25s; }

{% endblock %}
</style>

{% block content_fluid %}

<div class="card mt-2">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#import" href="#">
          <i class="bi bi-upload"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="">
          <i class="bi bi-arrow-left"></i> Voltar
        </a>
      </li>
    </ul>
  </div>

  <div class="card-body tab-content">
    <div class="tab-pane fade show active" id="import">
      
      <h5 class="card-title mb-4">
        {% translate 'Pessoal' %}: <b class="text-purple">Importação de Frequência</b>
      </h5>

      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step-item active" id="step-1">
          <div class="step-circle">1</div>
          <span>Upload</span>
        </div>
        <span class="step-arrow">→</span>
        <div class="step-item" id="step-2">
          <div class="step-circle">2</div>
          <span>Revisão</span>
        </div>
        <span class="step-arrow">→</span>
        <div class="step-item" id="step-3">
          <div class="step-circle">3</div>
          <span>Confirmação</span>
        </div>
      </div>

      <!-- Fase 1: Upload -->
      <div id="upload-phase">
        <form id="form-upload" enctype="multipart/form-data">
          {% csrf_token %}
          
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label for="{{ form.filial.id_for_label }}" class="form-label">
                <i class="bi bi-building"></i> {{ form.filial.label }}
              </label>
              {{ form.filial }}
            </div>
            
            <div class="col-md-6">
              <label for="{{ form.origem.id_for_label }}" class="form-label">
                <i class="bi bi-info-circle"></i> {{ form.origem.label }}
              </label>
              {{ form.origem }}
            </div>
          </div>

          <!-- Info sobre origem selecionada -->
          <div id="origem-info" class="file-info-card" style="display: none;">
            <div class="d-flex align-items-start gap-3">
              <i class="bi bi-info-circle-fill text-primary" style="font-size: 2rem;"></i>
              <div>
                <h6 class="mb-1" id="origem-nome"></h6>
                <p class="text-muted mb-1" id="origem-descricao"></p>
                <small class="text-muted">
                  <i class="bi bi-file-earmark"></i> Formato esperado: 
                  <code id="origem-formato"></code>
                </small>
              </div>
            </div>
          </div>

          <!-- Upload Zone -->
          <div class="upload-zone" id="upload-zone">
            <input type="file" id="arquivo" name="arquivo" hidden accept=".txt,.csv,.json">
            <div class="upload-icon">
              <i class="bi bi-cloud-arrow-up"></i>
            </div>
            <h5 class="mb-2">Arraste o arquivo aqui</h5>
            <p class="text-muted mb-3">ou clique para selecionar</p>
            <button type="button" class="btn btn-primary btn-lg" id="btn-select-file">
              <i class="bi bi-folder2-open"></i> Selecionar Arquivo
            </button>
          </div>

          <!-- Arquivo selecionado -->
          <div id="file-selected" class="file-info-card" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-3">
                <i class="bi bi-file-earmark-check-fill text-success" style="font-size: 2.5rem;"></i>
                <div>
                  <h6 class="mb-0" id="file-name"></h6>
                  <small class="text-muted" id="file-size"></small>
                </div>
              </div>
              <button type="button" class="btn btn-outline-danger btn-sm" id="btn-remove-file">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>

          <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5" id="btn-processar">
              <i class="bi bi-gear-fill"></i> Processar Arquivo
            </button>
          </div>
        </form>
      </div>

      <!-- Fase 2: Preview -->
      <div id="preview-phase" style="display: none;">
        
        <!-- Stats -->
        <div class="stats-card fade-in-up">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="total-registros">0</div>
              <div class="stat-label">Registros</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="total-funcionarios">0</div>
              <div class="stat-label">Funcionários</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="periodo-import">-</div>
              <div class="stat-label">Período</div>
            </div>
          </div>
        </div>

        <!-- Lista de funcionários -->
        <div id="preview-container" class="mb-4">
          <!-- Preenchido via JS -->
        </div>

        <!-- Ações -->
        <div class="text-center">
          <button type="button" class="btn btn-outline-secondary btn-lg me-2" id="btn-voltar">
            <i class="bi bi-arrow-left"></i> Voltar
          </button>
          <button type="button" class="btn btn-success btn-lg px-5" id="btn-confirmar">
            <i class="bi bi-check-circle-fill"></i> Confirmar Importação
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
  <div class="loading-spinner">
    <div class="spinner-border mb-3" role="status"></div>
    <h5 id="loading-text">Processando arquivo...</h5>
  </div>
</div>

{% endblock %}

<script>
{% block add_script %}
(function() {
  'use strict';

  const $$ = {
    formUpload: document.getElementById('form-upload'),
    uploadZone: document.getElementById('upload-zone'),
    fileInput: document.getElementById('arquivo'),
    btnSelectFile: document.getElementById('btn-select-file'),
    btnRemoveFile: document.getElementById('btn-remove-file'),
    btnProcessar: document.getElementById('btn-processar'),
    btnVoltar: document.getElementById('btn-voltar'),
    btnConfirmar: document.getElementById('btn-confirmar'),
    fileSelected: document.getElementById('file-selected'),
    fileName: document.getElementById('file-name'),
    fileSize: document.getElementById('file-size'),
    uploadPhase: document.getElementById('upload-phase'),
    previewPhase: document.getElementById('preview-phase'),
    previewContainer: document.getElementById('preview-container'),
    loadingOverlay: document.getElementById('loading-overlay'),
    loadingText: document.getElementById('loading-text'),
    origemInfo: document.getElementById('origem-info'),
    origemSelect: document.querySelector('[name="origem"]'),
  };

  const origensInfo = {{ origens_info|safe }};

  // Info sobre origem selecionada
  $$.origemSelect.addEventListener('change', function() {
    const origem = this.value;
    const info = origensInfo[origem];
    if (info) {
      $$.origemInfo.style.display = 'block';
      document.getElementById('origem-nome').textContent = info.nome;
      document.getElementById('origem-descricao').textContent = info.descricao;
      document.getElementById('origem-formato').textContent = info.formato;
    }
  });
  $$.origemSelect.dispatchEvent(new Event('change'));

  // Drag & Drop
  $$.uploadZone.addEventListener('click', () => $$.fileInput.click());
  $$.btnSelectFile.addEventListener('click', () => $$.fileInput.click());

  $$.uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    $$.uploadZone.classList.add('dragover');
  });

  $$.uploadZone.addEventListener('dragleave', () => {
    $$.uploadZone.classList.remove('dragover');
  });

  $$.uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    $$.uploadZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length) {
      $$.fileInput.files = files;
      showFileInfo(files[0]);
    }
  });

  $$.fileInput.addEventListener('change', function() {
    if (this.files.length) {
      showFileInfo(this.files[0]);
    }
  });

  $$.btnRemoveFile.addEventListener('click', () => {
    $$.fileInput.value = '';
    $$.fileSelected.style.display = 'none';
    $$.uploadZone.style.display = 'block';
  });

  function showFileInfo(file) {
    $$.fileName.textContent = file.name;
    $$.fileSize.textContent = formatFileSize(file.size);
    $$.fileSelected.style.display = 'block';
    $$.uploadZone.style.display = 'none';
  }

  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  // Submit upload
  $$.formUpload.addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!$$.fileInput.files.length) {
      alert('Selecione um arquivo');
      return;
    }

    showLoading('Processando arquivo...');

    const formData = new FormData(this);
    formData.append('step', 'upload');

    try {
      const response = await fetch(window.location.pathname, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      });

      const data = await response.json();

      if (data.success) {
        showPreview(data);
      } else {
        alert(data.error || 'Erro ao processar arquivo');
      }
    } catch (error) {
      alert('Erro: ' + error.message);
    } finally {
      hideLoading();
    }
  });

  function showPreview(data) {
    // Atualiza steps
    document.getElementById('step-1').classList.add('completed');
    document.getElementById('step-1').classList.remove('active');
    document.getElementById('step-2').classList.add('active');

    // Atualiza stats
    document.getElementById('total-registros').textContent = data.totais.registros;
    document.getElementById('total-funcionarios').textContent = data.totais.funcionarios;
    document.getElementById('periodo-import').textContent = data.totais.periodo;

    // Renderiza preview
    $$.previewContainer.innerHTML = '';
    data.preview.funcionarios.forEach((func, idx) => {
      const card = createFuncionarioCard(func, idx);
      $$.previewContainer.appendChild(card);
    });

    // Transição de fase
    $$.uploadPhase.style.display = 'none';
    $$.previewPhase.style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function createFuncionarioCard(func, idx) {
    const collapseId = `collapse-${idx}`;
    
    const card = document.createElement('div');
    card.className = 'funcionario-card';
    
    card.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="collapse-trigger" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
          <h6 class="mb-0">
            <i class="bi bi-chevron-right me-2"></i>
            <strong>${func.nome}</strong>
            <span class="text-muted ms-2">(${func.matricula})</span>
          </h6>
        </div>
        <span class="badge bg-primary">${func.total_dias} dias</span>
      </div>

      <div class="collapse" id="${collapseId}">
        <div class="table-responsive">
          <table class="table table-sm preview-table mb-0">
            <thead>
              <tr>
                <th>Data</th>
                <th>Batidas</th>
                <th>Total</th>
                <th>Alertas</th>
              </tr>
            </thead>
            <tbody>
              ${func.dias.map(dia => `
                <tr>
                  <td><strong>${dia.data}</strong></td>
                  <td>
                    ${dia.batidas.map(b => `
                      <span class="batida-badge">${b.hora}</span>
                    `).join('')}
                  </td>
                  <td><span class="badge bg-secondary">${dia.total}</span></td>
                  <td>
                    ${dia.alertas.map(alerta => `
                      <span class="alert-badge">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        ${alerta}
                      </span>
                    `).join('')}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;

    return card;
  }

  // Voltar
  $$.btnVoltar.addEventListener('click', () => {
    document.getElementById('step-2').classList.remove('active');
    document.getElementById('step-1').classList.remove('completed');
    document.getElementById('step-1').classList.add('active');
    
    $$.previewPhase.style.display = 'none';
    $$.uploadPhase.style.display = 'block';
  });

  // Confirmar
  $$.btnConfirmar.addEventListener('click', async () => {
    if (!confirm('Confirma a importação destes registros?')) {
      return;
    }

    showLoading('Salvando registros...');

    try {
      const response = await fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ step: 'confirm' })
      });

      const data = await response.json();

      if (data.success) {
        // Atualiza step final
        document.getElementById('step-2').classList.add('completed');
        document.getElementById('step-2').classList.remove('active');
        document.getElementById('step-3').classList.add('active');
        document.getElementById('step-3').classList.add('completed');
        
        // Redireciona
        setTimeout(() => {
          window.location.href = data.redirect;
        }, 1500);
      } else {
        alert(data.error || 'Erro ao confirmar importação');
        hideLoading();
      }
    } catch (error) {
      alert('Erro: ' + error.message);
      hideLoading();
    }
  });

  function showLoading(text) {
    $$.loadingText.textContent = text;
    $$.loadingOverlay.style.display = 'flex';
  }

  function hideLoading() {
    $$.loadingOverlay.style.display = 'none';
  }

})();
{% endblock %}
</script>
