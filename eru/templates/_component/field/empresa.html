<div class="{{container_classlist|default:'form-floating col-lg mb-1'}}">
	<select class="{{input_classlist|default:'form-select'}}" id="id_empresa" data-i18n="[placeholder]common.company" name="empresa" {{attrs}}></select>
	{% if label != False %}<label for="id_empresa" data-i18n="common.company">Empresa</label>{% endif %}
</div>

<script>
  /**
   * Popula o select de empresas via AJAX e retorna uma Promise
   * @returns {Promise<void>}
   */
  function setupEmpresasComponent() {
    const selectEmpresa = document.getElementById("id_empresa");
    const empresaAtual = '{{empresa_atual}}';
    const blankRowEnabled = {{blank_row|default:'false'}};

    return fetch("{% url 'get_empresas' %}")
      .then(response => response.json())
      .then(data => {
        let optionsHtml = '';

        if (blankRowEnabled) {
          const blankMessage = i18n ? i18n.getEntry('common.all') || '{{blank_row_message|default:"--"}}' : '{{blank_row_message|default:"--"}}';
          optionsHtml += `<option value="" data-i18n="common.all">${blankMessage}</option>`;
        }
        
        data.forEach(empresa => {
          const selected = empresa.pk == empresaAtual ? 'selected' : '';
          optionsHtml += `<option value="${empresa.pk}" ${selected}>${empresa.fields.nome}</option>`;
        });

        selectEmpresa.innerHTML = optionsHtml;
        selectEmpresa.dispatchEvent(new Event('componentLoaded'));
      })
      .catch(error => {
        console.error("Erro ao carregar empresas:", error);
        throw error; 
      });
  }
  // caso ainda nao exista, cria lista para os promisses
  if (!window.componentPromises) { window.componentPromises = []}
  window.componentPromises.push(setupEmpresasComponent());
</script>